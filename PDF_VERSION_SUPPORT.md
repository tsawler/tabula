# PDF Version Support

This document tracks which PDF specification versions Tabula supports.

## Overview

PDF has evolved significantly since 1993. Tabula aims to support **PDF 2.0 (ISO 32000-2:2017)** as the ultimate goal, with **PDF 1.7 (ISO 32000-1:2008)** as the primary initial target and full backward compatibility for older versions.

**Strategic Priorities:**
1. **Tagged PDF Support (1.7/2.0)** - Critical for RAG pipelines (reading order, structure, logical sections)
2. **PDF 1.7 Full Support** - Most common version in production today
3. **PDF 2.0 Full Support** - Future-proofing for enterprise adoption

## Version History

| Version | Year | ISO Standard | Status | Notes |
|---------|------|--------------|--------|-------|
| PDF 1.0 | 1993 | - | âœ… Supported | Basic features |
| PDF 1.1 | 1994 | - | âœ… Supported | Encryption, device-independent color |
| PDF 1.2 | 1996 | - | âœ… Supported | Interactive forms, CJK fonts |
| PDF 1.3 | 1999 | - | âœ… Supported | Digital signatures, annotations |
| PDF 1.4 | 2001 | - | âœ… Supported | Transparency, **Tagged PDF introduced** |
| PDF 1.5 | 2003 | - | âœ… Supported | XRef streams âœ…, object streams (pending) |
| PDF 1.6 | 2005 | - | ğŸš§ Partial | AES encryption (Phase 4) |
| PDF 1.7 | 2006 | ISO 32000-1:2008 | ğŸ¯ **Primary Target** | Most common version today |
| PDF 2.0 | 2017 | ISO 32000-2:2017 | ğŸ¯ **Ultimate Goal** | Future-proofing, enterprise adoption |

## Feature Support Matrix

### Core Features (Phase 1) âœ…

| Feature | PDF Version | Status | Notes |
|---------|-------------|--------|-------|
| Traditional XRef tables | 1.0+ | âœ… Implemented | Task 1.5 |
| Basic object types | 1.0+ | âœ… Implemented | Task 1.2-1.4 |
| FlateDecode compression | 1.2+ | âœ… Implemented | Task 1.9 |
| Content streams | 1.0+ | âœ… Implemented | Task 1.11 |
| Page tree | 1.0+ | âœ… Implemented | Task 1.8 |

### Font Support (Phase 2) âœ…

| Feature | PDF Version | Status | Notes |
|---------|-------------|--------|-------|
| Type1 fonts | 1.0+ | âœ… Implemented | Task 2.1 |
| TrueType fonts | 1.0+ | âœ… Implemented | Task 2.2 |
| CIDFont/Type0 (CJK) | 1.2+ | âœ… Implemented | Task 2.3 |
| ToUnicode CMaps | 1.2+ | ğŸ“‹ Planned | Task 2.4 |

### Modern PDF Features ğŸš§

| Feature | PDF Version | Status | Notes |
|---------|-------------|--------|-------|
| XRef streams | 1.5+ | âœ… **IMPLEMENTED** | Completed Nov 25, 2024 - Modern PDFs supported! |
| Object streams | 1.5+ | ğŸ“‹ Planned | Compressed objects (Phase 1) |
| Tagged PDF | 1.4+ | ğŸ¯ **HIGH PRIORITY** | Critical for RAG (see below) |
| AES encryption | 1.6+ | ğŸ“‹ Planned | Phase 4, Task 4.12 |
| RC4 encryption | 1.1+ | ğŸ“‹ Planned | Phase 4, Task 4.12 |
| PDF/A compliance | Various | ğŸ“‹ Planned | Phase 6, Task 6.6 |
| UTF-8 strings | 2.0 | ğŸ“‹ Planned | Phase 6 |
| AES-256 encryption | 2.0 | ğŸ“‹ Planned | Phase 6 |

### Compression Filters

| Filter | PDF Version | Status | Notes |
|--------|-------------|--------|-------|
| FlateDecode | 1.2+ | âœ… Implemented | zlib/deflate |
| LZWDecode | 1.0+ | ğŸ“‹ Planned | Phase 1 |
| DCTDecode (JPEG) | 1.0+ | ğŸ“‹ Planned | Phase 4 |
| ASCII85Decode | 1.0+ | âœ… Implemented | Phase 1 |
| ASCIIHexDecode | 1.0+ | âœ… Implemented | Phase 1 |
| CCITTFaxDecode | 1.0+ | ğŸ“‹ Planned | Phase 4 |
| JBIG2Decode | 1.4+ | ğŸ“‹ Planned | Phase 6 |
| JPXDecode (JPEG2000) | 1.5+ | ğŸ“‹ Planned | Phase 6 |

## Critical Gap: XRef Streams (PDF 1.5+)

**Problem:** Most modern PDFs use XRef streams instead of traditional XRef tables. Without XRef stream support, we cannot read:

- PDFs generated by modern tools (Adobe Acrobat DC, Chrome, etc.)
- Linearized PDFs (optimized for web viewing)
- PDFs with compressed object streams
- Most PDF 1.7 documents in the wild

**Impact:** This is a **blocking issue** for production use. Without it, Tabula can only read older PDFs (pre-2003).

**Solution:** Add Task 1.5b to implement XRef stream parsing before completing Phase 1.

### Recommended: Insert Task 1.5b

**Task 1.5b: XRef Stream Support (12 hours)** ğŸš¨ **CRITICAL**

```markdown
- [ ] Implement XRef stream parsing in `core/xref.go`
- [ ] Detect XRef stream vs traditional table
- [ ] Parse XRef stream dictionary
- [ ] Decode compressed XRef data
- [ ] Support Index and W arrays
- [ ] Handle hybrid-reference files (both XRef types)
- [ ] Write XRef stream tests
```

**Priority:** **IMMEDIATE** - This should be implemented right after Task 2.3 or before Phase 2 completion.

## Version Detection

The PDF version is specified in two places:

1. **File header**: `%PDF-1.7` (first line)
2. **Catalog dictionary**: `/Version /1.7` (optional, overrides header)

**Implementation:**

```go
// In reader/reader.go
type Reader struct {
    version string  // e.g., "1.7"
}

// Parse header
func (r *Reader) parseHeader() error {
    // Read "%PDF-X.Y"
    header := readLine(r.file)
    r.version = extractVersion(header) // "1.7"
}

// Check catalog version override
func (r *Reader) loadCatalog() error {
    catalog := r.resolver.Resolve(r.trailer.Get("Root"))
    if version := catalog.Get("Version"); version != nil {
        r.version = string(version.(core.Name)) // Override
    }
}
```

## Compatibility Strategy

### Read (Parsing)

**Goal:** Read as many PDFs as possible, regardless of version.

**Strategy:**
1. **Best-effort parsing** - Handle variations gracefully
2. **Feature detection** - Check for features, not versions
3. **Fallbacks** - Degrade gracefully when features missing
4. **Lenient mode** - Tolerate spec violations (optional strict mode)

### Write (Generation)

**Goal:** Generate clean, compatible PDFs.

**Strategy:**
1. **Default to PDF 1.7** - Widest compatibility
2. **Minimal features** - Use simplest approach
3. **Traditional XRef** - Better compatibility than streams
4. **Optional modern features** - User can opt into 1.5+ features

## Testing Strategy

### Test Corpus

Collect PDFs across versions:

- **PDF 1.0-1.4**: At least 2 samples each
- **PDF 1.5**: 5+ samples (XRef streams)
- **PDF 1.6**: 3+ samples (AES encryption)
- **PDF 1.7**: 10+ samples (most common)
- **PDF 2.0**: 2+ samples (latest)

### Version-Specific Tests

```go
// Test traditional XRef (PDF 1.0-1.4)
func TestPDF14_TraditionalXRef(t *testing.T) { ... }

// Test XRef streams (PDF 1.5+)
func TestPDF15_XRefStreams(t *testing.T) { ... }

// Test AES encryption (PDF 1.6+)
func TestPDF16_AESEncryption(t *testing.T) { ... }

// Test PDF 2.0 features
func TestPDF20_Features(t *testing.T) { ... }
```

## Tagged PDF Support ğŸ¯ CRITICAL FOR RAG

**What is Tagged PDF?**

Tagged PDF (introduced in PDF 1.4, enhanced in 2.0) embeds logical structure information that maps visual content to semantic meaning.

**Why Critical for RAG:**

1. **Reading Order** - Explicit reading order, not guessed from coordinates
2. **Logical Structure** - Paragraphs, headings, lists, tables marked explicitly
3. **Table Structure** - Table headers, rows, cells identified structurally
4. **Section Hierarchy** - Document outline with H1-H6 relationships
5. **Accessibility Tree** - Alt text, roles, relationships

**Without Tagged PDF:** We guess structure from positions (error-prone)
**With Tagged PDF:** We read the author's intended structure (accurate)

### Tagged PDF Implementation Priority

**Task 2.x: Tagged PDF Support (20 hours)** ğŸ¯ **RAG CRITICAL** - Insert after Task 2.3

```markdown
- [ ] Implement `core/structtree.go` - Parse structure tree
- [ ] Parse StructTreeRoot and parent tree
- [ ] Parse structure elements (Document, Part, Sect, H1-H6, P, L, Table, etc.)
- [ ] Extract marked content sequences (MCID)
- [ ] Map structure elements to page content
- [ ] Build logical document tree
- [ ] Extract reading order from structure
- [ ] Extract table structure from Table elements
- [ ] Handle role mapping (custom tags â†’ standard tags)
- [ ] Write tagged PDF tests with real tagged documents
```

**Deliverable:** Accurate structure extraction from tagged PDFs
**RAG Impact:** 10-50x better chunking accuracy for tagged documents

### Implementation Strategy

**Phase 1:** Detect and parse tagged structure
**Phase 2:** Use tagged structure when available, fall back to geometric analysis
**Phase 3:** Prefer tagged structure over geometric heuristics

## PDF 2.0 Full Support ğŸ¯ ULTIMATE GOAL

PDF 2.0 (ISO 32000-2:2017) is the future. We will implement full support to future-proof Tabula.

**New Features in PDF 2.0:**

1. **UTF-8 text strings** - Simpler encoding, replaces UTF-16BE
2. **Enhanced Tagged PDF** - Richer structure vocabulary
3. **Deprecations** - Removed obsolete features (cleaner spec)
4. **Enhanced encryption** - SHA-256, SHA-512, AES-256
5. **Geospatial features** - Enhanced geo-positioning
6. **Associated files** - Better embedded file handling
7. **Page-level output intents** - Better color management
8. **Improved transparency** - Extended graphics state

**Why PDF 2.0 Matters:**

- **Enterprise adoption growing** - Government, financial, legal sectors
- **Better for structured extraction** - Enhanced Tagged PDF
- **Modern security** - AES-256, SHA-256
- **Future-proofing** - As software updates, more 2.0 files will appear

**Implementation Timeline:**

- **Phase 1-3:** Focus on PDF 1.7 + XRef streams + Tagged PDF
- **Phase 4:** Add encryption (RC4, AES-128, AES-256)
- **Phase 5:** Optimize performance
- **Phase 6:** Full PDF 2.0 compliance

**Status:** Planned for Phase 6, after PDF 1.7 is solid.

## Recommendations

### For Production Use (v1.0)

**Must support:**
- âœ… PDF 1.0-1.4 (traditional XRef)
- ğŸš§ PDF 1.5-1.7 (XRef streams) **â† IN PROGRESS (Task 1.5b)**
- ğŸ¯ Tagged PDF (1.4+) **â† HIGH PRIORITY for RAG**
- ğŸš§ Common encryption (RC4, AES-128)

**Should support:**
- ğŸ¯ PDF 2.0 text strings (UTF-8)
- ğŸ¯ PDF 2.0 enhanced Tagged PDF
- ğŸ“‹ Linearized PDFs
- ğŸ“‹ Object streams (PDF 1.5+)

**Nice to have:**
- ğŸ“‹ PDF/A validation
- ğŸ“‹ AES-256 encryption (PDF 2.0)
- ğŸ“‹ Digital signatures

### Implementation Priority

**Immediate (Phase 1-2):**
1. âœ… **Task 1.5b** - XRef streams **â† COMPLETED Nov 25, 2024**
2. ğŸ¯ **Task 2.x** - Tagged PDF structure parsing **â† HIGH PRIORITY**
3. ğŸ“‹ Complete Phase 2 font support (Tasks 2.4-2.5)

**Short-term (Phase 3-4):**
4. ğŸ“‹ Object streams (PDF 1.5+)
5. ğŸ“‹ Encryption (RC4, AES-128, AES-256)
6. ğŸ“‹ Enhanced tagged structure support

**Long-term (Phase 6):**
7. ğŸ“‹ Full PDF 2.0 compliance
8. ğŸ“‹ UTF-8 string support
9. ğŸ“‹ PDF/A validation

## Current Status Summary

### What Works Today âœ…
- PDF 1.0-1.5 with both traditional and stream XRef tables
- Type1, TrueType, and CIDFont support
- FlateDecode compression
- Basic text extraction
- **Modern PDFs (1.5+) now supported with XRef streams!**

### Remaining Priorities ğŸ¯
- **Tagged PDF support** - Critical for RAG quality
- **Object streams** - Further PDF 1.5+ feature support
- **ToUnicode CMaps** - Complete font support

### Status
XRef stream support completed November 25, 2024. Tabula can now read modern PDFs generated by Chrome, Adobe Acrobat DC, and other PDF 1.5+ tools!

## Version Target Summary

| Target | Version | Rationale |
|--------|---------|-----------|
| **Ultimate Goal** | PDF 2.0 | Future-proofing, enterprise adoption, enhanced Tagged PDF |
| **Primary Target** | PDF 1.7 | Most common version today (ISO 32000-1:2008) |
| **Minimum Support** | PDF 1.0 | Full backwards compatibility |

### Strategic Roadmap

**Phase 1-2 (Current):**
- âœ… PDF 1.0-1.4 full support
- ğŸš§ PDF 1.5+ XRef streams (Task 1.5b - in progress)
- ğŸ¯ Tagged PDF parsing (Task 2.x - high priority)

**Phase 3-5:**
- ğŸ“‹ PDF 1.7 complete support (encryption, all features)
- ğŸ“‹ Object streams (PDF 1.5+)
- ğŸ“‹ Performance optimization

**Phase 6:**
- ğŸ¯ PDF 2.0 full compliance
- ğŸ¯ Enhanced Tagged PDF support
- ğŸ¯ Modern security features

**Bottom line:**
- **Immediate:** XRef streams unlock modern PDFs (1.5+)
- **High Priority:** Tagged PDF enables superior RAG quality
- **Ultimate Goal:** Full PDF 2.0 support for enterprise future-proofing
