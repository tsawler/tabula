# MS Word / Quartz PDF Fixes

## Issues Identified
PDFs generated by Microsoft Word on macOS (Quartz PDFContext) exhibited two major issues:

1.  **Garbled Text**: The ToUnicode CMap streams used "tightly packed" hex strings (e.g., `<21><21><0052>`) without whitespace. The previous parser relied on `strings.Fields()`, causing it to fail and fall back to raw character codes.
2.  **Interleaved Text / Layout Issues**: The text extraction produced interleaved lines (e.g., `RecFor yfcolre...`). This was caused by:
    *   **Incorrect Cursor Advancement**: The `Tj` operator was using a simplified width calculation (`FontSize * length`) instead of actual font metrics. Since the font was variable-width, the cursor position drifted significantly, causing subsequent text to be placed incorrectly (often overlapping).
    *   **Missing CTM Scaling**: The `FontSize` reported in `TextFragment` was in text space (untransformed by CTM), while `Y` coordinates were in device space. When the CTM had a scaling factor (e.g., 0.24), the font size appeared much larger than the line height, causing the line grouping logic to merge adjacent lines.

## Fixes Implemented

### 1. CMap Parser Fix
*   Updated `tabula/font/cmap.go` to parse hex strings by scanning for `<` and `>` delimiters instead of relying on whitespace.
*   Added regression test `TestCMapTightPacking`.

### 2. Text Extraction Fixes
*   **Accurate Cursor Positioning**: Updated `tabula/graphicsstate/state.go` to add `ShowTextWithWidth`, which accepts the pre-calculated glyph width.
*   **Font Metrics Integration**: Updated `tabula/text/extractor.go` to calculate the actual text width using font metrics (`GetStringWidth`) and pass it to `ShowTextWithWidth`.
*   **CTM Scaling Support**: Updated `tabula/text/extractor.go` to apply the CTM scaling factor to `FontSize` and `Height` in `TextFragment`. This ensures that layout analysis (line grouping) works correctly even when the page is scaled via CTM.

## Verification
*   Verified with `pdf-samples/rnb.pdf`.
*   Text is now extracted correctly with proper layout and spacing.
*   Interleaving issue is resolved.
